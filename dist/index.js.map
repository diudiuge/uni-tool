{"version":3,"sources":["../src/cli.ts","../src/i18n/index.js","../src/i18n/handler.js","../src/i18n/baidu.js","../src/i18n/config.js"],"sourcesContent":["import cac from \"cac\";\nimport handler from \"./i18n\";\n\nconst cli = cac();\n// 提取需要翻译的文本， 并修改代码\ncli\n  .command(\"i18n\", \"提取当前项目下多语言的文本， 进行处理并翻译\")\n  // .option(\"-d, --delete\", \"清除翻译缓存\")\n  // .option(\"translate <from> <to>\", \"针对已解析出的缓存文件翻译出另外的语言\")\n  .option(\"back\", \"回退代码\")\n  .action(async ({ back }) => {\n    global.i18n.back = back;\n    handler();\n  });\n\ncli.help();\ncli.parse();\n// 已经npm link了， 可以全局实用 uni-tool\n","import { resolve } from \"path\";\nimport { readFileSync, writeFileSync, existsSync, mkdirSync } from \"fs\";\nimport handler from \"./handler\";\nimport { translate } from \"./baidu\";\nimport * as defaultConfig from \"./config\";\n\nglobal.i18n = {}\nglobal.i18n.config = defaultConfig;\n\n// 提取需要翻译的文本， 并修改代码\nexport default async function () {\n  const root = process.cwd();\n  global.i18n.cacheDir = resolve(root, \".i18n\");\n  // 读取项目本地配置\n  if (existsSync(resolve(global.i18n.cacheDir, 'config.js'))) {\n    const config = require(resolve(global.i18n.cacheDir, 'config.js'))\n    global.i18n.config = config\n  }\n  if (!existsSync(global.i18n.cacheDir)) mkdirSync(global.i18n.cacheDir);\n\n  // 获取所有文本\n  const allText = handler(root);\n  // 不进行翻译\n  if (global.i18n.back) return\n\n  // 获取缓存的翻译文件， 对比翻译\n  // TODO\n\n  // 缓存， 生成\n  // 格式： {uniKey: text}\n  writeFileSync(\n    resolve(global.i18n.cacheDir, `${global.i18n.config.from}.json`),\n    JSON.stringify(allText, null, 2)\n  );\n\n  // 生成翻译数据\n  global.i18n.config.to.forEach(async toTranslate => {\n    const translateText = await translate(\n      allText,\n      global.i18n.config.from,\n      toTranslate\n    );\n\n    // 格式： {uniKey: text}\n    writeFileSync(\n      resolve(global.i18n.cacheDir, `${toTranslate}.json`),\n      JSON.stringify(translateText, null, 2)\n    );\n  })\n\n}\n","import { resolve, extname } from \"path\"\nimport { readdirSync, statSync, readFileSync, writeFileSync } from \"fs\"\nimport MagicString from \"magic-string\"\n\n// 唯一id\nlet i18nIndex = 0;\nfunction nextKey() {\n  ++i18nIndex;\n  return `${global.i18n.config.prefix}${i18nIndex}`;\n}\nlet allText = {};\n\nconst deepRead = (root) => {\n  let dirs = readdirSync(root)\n  // 过滤不处理文件夹\n  dirs = dirs.filter(dir => !global.i18n.config.ignoreDirs.includes(dir))\n  dirs.forEach(dirPath => {\n    const fullPath = resolve(root, dirPath)\n    const fileStat = statSync(fullPath)\n    if (fileStat.isDirectory()) {\n      deepRead(resolve(root, dirPath))\n    } else {\n      const file = readFileSync(fullPath, 'utf-8')\n\n      // 过滤不处理文件\n      if (global.i18n.config.ignoreExts.includes(extname(fullPath || ''))) return\n\n      const fileString = new MagicString(file);\n      fileString.replace(global.i18n.config.reg, (...args) => {\n        const key = nextKey()\n        allText = global.i18n.config.handlerResult(allText, key, args)\n\n        // 回退\n        if (global.i18n.back) {\n          return global.i18n.config.backHandler(allText, key, args)\n        }\n        return global.i18n.config.handlerTemlpate(allText, key, args)\n      })\n      writeFileSync(fullPath, fileString.toString());\n\n      // // 重写文件 sourceMap\n      // if (fileString.hasChanged()) {\n      //   const fileMap = fileString.generateMap({\n      //     source: fullPath,\n      //     file: `${fullPath}.map`,\n      //     includeContent: true\n      //   });\n      //   writeFileSync(`${fullPath}.map`, fileMap.toString());\n      // }\n    }\n  })\n}\n\n\nexport default function (root) {\n  deepRead(root)\n  return allText;\n}\n","import md5 from \"md5\"\nimport axios from \"axios\"\n\nconst queryHandler = (allText) => {\n  // 标准版单次最长请求由6000字节改为1000字符\n  allText = allText.reduce((a, b) => {\n    if (a.length > 0) {\n      let lastArr = a.pop();\n      if (lastArr.length < 20)\n        return [...a, [...lastArr, b]]\n      return [...a, lastArr, [b]]\n    }\n\n    return [...a, [b]]\n  }, [])\n  // 多个query可以用\\n连接  如 query='apple\\norange\\nbanana\\npear'\n  return allText\n}\n\n// https://api.fanyi.baidu.com/api/trans/product/desktop\nexport const translate = async (allText, from, to) => {\n  try {\n    const allTextValues = Object.values(allText)\n    const allTextKeys = Object.keys(allText)\n    const chankValues = queryHandler(allTextValues);\n    const chankKeys = queryHandler(allTextKeys);\n    const querys = chankValues.map(v => v.join('\\n'))\n\n\n    let res = [];\n    for (let i = 0; i < querys.length; i++) {\n      const query = querys[i]\n      const salt = (new Date).getTime();\n      const str1 = global.i18n.config.appid + query + salt + global.i18n.config.key;\n      const sign = md5(str1);\n      const response = await axios.get('http://api.fanyi.baidu.com/api/trans/vip/translate', {\n        params: {\n          q: query,\n          appid: global.i18n.config.appid,\n          salt: salt,\n          from: from,\n          to: to,\n          sign: sign\n        }\n      })\n\n      const result = response.data\n      if (result && result.error_code)\n        throw new Error(result.error_code)\n\n      res = [...res, ...result.trans_result.map((item, j) => {\n        if (!chankKeys[i] || !chankKeys[i][j]) {\n          throw new Error(JSON.stringify(item))\n        }\n        return { key: chankKeys[i][j], item }\n      })]\n    }\n\n    return res.reduce((a, b) => ({ ...a, [b.key]: b.item.dst }), {})\n\n  } catch (error) {\n    console.log(error)\n  }\n}\n\n\n","const fs = require('fs')\nconst path = require('path')\n\nexport const appid = ''\nexport const key = ''\n// 语种 https://api.fanyi.baidu.com/doc/21\n// export const from = 'zh'\nexport const from = 'cht'\nexport const to = ['en', 'zh']\nexport const ignoreDirs = [\n  '.hbuilderx', 'node_modules', 'uni_modules', 'unpackage', '.git', 'dist', 'static'\n]\nexport const ignoreExts = [\".woff2\", '.jpg', '.png', '.pdf', '.keystore']\nexport const reg = new RegExp(/\\$t\\(('|\"|`)(.*?)('|\"|`)\\)/g)\nexport const prefix = 'i18n_';\nexport const handlerResult = (allText, nextKey, [_, $1, $2, $3]) => {\n  allText[nextKey] = $2;\n  return allText\n}\nexport const handlerTemlpate = (allText, nextKey, [_, $1, $2, $3]) => {\n  return `$t(${$1}${nextKey}${$3})`\n}\n\nlet json\nexport const getCacheFromJson = () => {\n  if (json) return json;\n  const jsonFile = fs.readFileSync(path.resolve(global.i18n.cacheDir, `./${global.i18n.cacheDir}.json`), 'utf-8')\n  json = JSON.parse(jsonFile)\n  return json;\n}\n\nexport const backHandler = (allText, nextKey, [_, $1, $2, $3]) => {\n  const json = getCacheFromJson();\n  return `$t(${$1}${json[nextKey] ? json[nextKey] : ''}${$3})`\n}\n"],"mappings":"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","names":["import_cac","import_path","import_fs","import_path","import_fs","import_magic_string","i18nIndex","nextKey","allText","deepRead","root","dirs","dir","dirPath","fullPath","file","fileString","MagicString","args","key","handler_default","import_md5","import_axios","queryHandler","allText","a","b","lastArr","translate","from","to","allTextValues","allTextKeys","chankValues","chankKeys","querys","v","res","query","salt","str1","sign","md5","result","axios","item","j","error","config_exports","__export","appid","backHandler","from","getCacheFromJson","handlerResult","handlerTemlpate","ignoreDirs","ignoreExts","key","prefix","reg","to","fs","path","allText","nextKey","_","$1","$2","$3","json","jsonFile","config_exports","i18n_default","root","config","allText","handler_default","toTranslate","translateText","translate","cli","cac","back","i18n_default"]}